(window.webpackJsonp=window.webpackJsonp||[]).push([[104],{756:function(t,s,a){"use strict";a.r(s);var e=a(12),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"第一章-react理念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一章-react理念"}},[t._v("#")]),t._v(" 第一章 React理念")]),t._v(" "),a("h3",{attrs:{id:"react理念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react理念"}},[t._v("#")]),t._v(" React理念")]),t._v(" "),a("h4",{attrs:{id:"react理念-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react理念-2"}},[t._v("#")]),t._v(" React理念")]),t._v(" "),a("p",[t._v("我们可以从"),a("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/thinking-in-react.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("官网 (opens new window)"),a("OutboundLink")],1),t._v("看到"),a("code",[t._v("React")]),t._v("的理念：")]),t._v(" "),a("blockquote",[a("p",[t._v("我们认为，React 是用 JavaScript 构建"),a("strong",[t._v("快速响应")]),t._v("的大型 Web 应用程序的首选方式。它在 Facebook 和 Instagram 上表现优秀。")])]),t._v(" "),a("p",[t._v("可见，关键是实现"),a("code",[t._v("快速响应")]),t._v("。那么制约"),a("code",[t._v("快速响应")]),t._v("的因素是什么呢？")]),t._v(" "),a("p",[t._v("我们日常使用App，浏览网页时，有两类场景会制约"),a("code",[t._v("快速响应")]),t._v("：")]),t._v(" "),a("ul",[a("li",[t._v("当遇到大计算量的操作或者设备性能不足使页面掉帧，导致卡顿。")]),t._v(" "),a("li",[t._v("发送网络请求后，由于需要等待数据返回才能进一步操作导致不能快速响应。")])]),t._v(" "),a("p",[t._v("这两类场景可以概括为：")]),t._v(" "),a("ul",[a("li",[t._v("CPU的瓶颈")]),t._v(" "),a("li",[t._v("IO的瓶颈")])]),t._v(" "),a("p",[a("code",[t._v("React")]),t._v("是如何解决这两个瓶颈的呢？")]),t._v(" "),a("h4",{attrs:{id:"cpu的瓶颈"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cpu的瓶颈"}},[t._v("#")]),t._v(" CPU的瓶颈")]),t._v(" "),a("p",[t._v("当项目变得庞大、组件数量繁多时，就容易遇到CPU的瓶颈。")]),t._v(" "),a("p",[t._v("考虑如下Demo，我们向视图中渲染3000个"),a("code",[t._v("li")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" len "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ul"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Array")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fill")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" i")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("li"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("li"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("ul"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rootEl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#root"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReactDOM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("App"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rootEl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  \n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("p",[t._v("​\t主流浏览器刷新频率为60Hz，即每（1000ms / 60Hz）16.6ms浏览器刷新一次。")]),t._v(" "),a("p",[t._v("​\t我们知道，JS可以操作DOM，"),a("code",[t._v("GUI渲染线程")]),t._v("与"),a("code",[t._v("JS线程")]),t._v("是互斥的。所以"),a("strong",[t._v("JS脚本执行")]),t._v("和"),a("strong",[t._v("浏览器布局、绘制")]),t._v("不能同时执行。")]),t._v(" "),a("p",[t._v("在每16.6ms时间内，需要完成如下工作：")]),t._v(" "),a("ol",[a("li",[t._v("JS脚本执行")]),t._v(" "),a("li",[t._v("样式布局")]),t._v(" "),a("li",[t._v("样式绘制")])]),t._v(" "),a("p",[t._v("​\t当JS执行时间过长，超出16.6ms，这次刷新就没有时间执行 "),a("strong",[t._v("样式布局")]),t._v("和 "),a("strong",[t._v("样式绘制")]),t._v("了。")]),t._v(" "),a("p",[t._v("​\t在Demo中，由于组件数量繁多（3000个），JS脚本执行时间过长，页面掉帧，造成卡顿。")]),t._v(" "),a("p",[t._v("​\t可以从打印的执行堆栈图看到，JS执行时间为73.65ms，远远多于一帧的时间。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241313346.png",alt:"长任务"}})]),t._v(" "),a("p",[t._v("如何解决这个问题呢？")]),t._v(" "),a("p",[t._v("答案是：在浏览器每一帧的时间中，预留一些时间给JS线程，"),a("code",[t._v("React")]),t._v("利用这部分时间更新组件（可以看到，在"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L119",target:"_blank",rel:"noopener noreferrer"}},[t._v("源码 (opens new window)"),a("OutboundLink")],1),t._v("中，预留的初始时间是5ms）。")]),t._v(" "),a("p",[t._v("当预留的时间不够用时，"),a("code",[t._v("React")]),t._v("将线程控制权交还给浏览器使其有时间渲染UI，"),a("code",[t._v("React")]),t._v("则等待下一帧时间到来继续被中断的工作。")]),t._v(" "),a("blockquote",[a("p",[t._v("这种将长任务分拆到每一帧中，像蚂蚁搬家一样一次执行一小段任务的操作，被称为"),a("code",[t._v("时间切片")]),t._v("（time slice）")])]),t._v(" "),a("p",[t._v("接下来我们开启"),a("code",[t._v("Concurrent Mode")]),t._v("（后续章节会讲到，当前你只需了解开启后会启用"),a("code",[t._v("时间切片")]),t._v("）：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通过使用ReactDOM.unstable_createRoot开启Concurrent Mode")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ReactDOM.render(<App/>, rootEl);  ")]),t._v("\nReactDOM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unstable_createRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rootEl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("App"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("此时我们的长任务被拆分到每一帧不同的"),a("code",[t._v("task")]),t._v("中，"),a("code",[t._v("JS脚本")]),t._v("执行时间大体在"),a("code",[t._v("5ms")]),t._v("左右，这样浏览器就有剩余时间执行"),a("strong",[t._v("样式布局")]),t._v("和"),a("strong",[t._v("样式绘制")]),t._v("，减少掉帧的可能性。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241315311.png",alt:"长任务"}})]),t._v(" "),a("p",[t._v("所以，解决"),a("code",[t._v("CPU瓶颈")]),t._v("的关键是实现"),a("code",[t._v("时间切片")]),t._v("，而"),a("code",[t._v("时间切片")]),t._v("的关键是：将"),a("strong",[t._v("同步的更新")]),t._v("变为"),a("strong",[t._v("可中断的异步更新")]),t._v("。")]),t._v(" "),a("h4",{attrs:{id:"io的瓶颈"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#io的瓶颈"}},[t._v("#")]),t._v(" IO的瓶颈")]),t._v(" "),a("p",[a("code",[t._v("网络延迟")]),t._v("是前端开发者无法解决的。如何在"),a("code",[t._v("网络延迟")]),t._v("客观存在的情况下，减少用户对"),a("code",[t._v("网络延迟")]),t._v("的感知？")]),t._v(" "),a("p",[a("code",[t._v("React")]),t._v("给出的答案是"),a("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-intro.html#putting-research-into-production",target:"_blank",rel:"noopener noreferrer"}},[t._v("将人机交互研究的结果整合到真实的 UI 中 (opens new window)"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("这里我们以业界人机交互最顶尖的苹果举例，在IOS系统中：")]),t._v(" "),a("p",[t._v("点击“设置”面板中的“通用”，进入“通用”界面：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241318476.gif",alt:"同步"}})]),t._v(" "),a("p",[t._v("作为对比，再点击“设置”面板中的“Siri与搜索”，进入“Siri与搜索”界面：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://react.iamkasong.com/img/concurrent-mov.gif",alt:"异步"}})]),t._v(" "),a("p",[t._v("你能感受到两者体验上的区别么？")]),t._v(" "),a("p",[t._v("事实上，点击“通用”后的交互是同步的，直接显示后续界面。而点击“Siri与搜索”后的交互是异步的，需要等待请求返回后再显示后续界面。但从用户感知来看，这两者的区别微乎其微。")]),t._v(" "),a("p",[t._v("这里的窍门在于：点击“Siri与搜索”后，先在当前页面停留了一小段时间，这一小段时间被用来请求数据。")]),t._v(" "),a("p",[t._v("当“这一小段时间”足够短时，用户是无感知的。如果请求时间超过一个范围，再显示"),a("code",[t._v("loading")]),t._v("的效果。")]),t._v(" "),a("p",[t._v("试想如果我们一点击“Siri与搜索”就显示"),a("code",[t._v("loading")]),t._v("效果，即使数据请求时间很短，"),a("code",[t._v("loading")]),t._v("效果一闪而过。用户也是可以感知到的。")]),t._v(" "),a("p",[t._v("为此，"),a("code",[t._v("React")]),t._v("实现了"),a("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-suspense.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Suspense (opens new window)"),a("OutboundLink")],1),t._v("功能及配套的"),a("code",[t._v("hook")]),t._v("——"),a("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-reference.html#usedeferredvalue",target:"_blank",rel:"noopener noreferrer"}},[t._v("useDeferredValue (opens new window)"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("而在源码内部，为了支持这些特性，同样需要将"),a("strong",[t._v("同步的更新")]),t._v("变为"),a("strong",[t._v("可中断的异步更新")]),t._v("。")]),t._v(" "),a("h4",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("通过以上内容，我们可以看到，"),a("code",[t._v("React")]),t._v("为了践行“构建"),a("strong",[t._v("快速响应")]),t._v("的大型 Web 应用程序”理念做出的努力。")]),t._v(" "),a("p",[t._v("其中的关键是解决CPU的瓶颈与IO的瓶颈。而落实到实现上，则需要将"),a("strong",[t._v("同步的更新")]),t._v("变为"),a("strong",[t._v("可中断的异步更新")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"老的react架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#老的react架构"}},[t._v("#")]),t._v(" 老的React架构")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[t._v("​\t"),a("code",[t._v("React")]),t._v("从v15升级到v16后重构了整个架构。本节我们聊聊v15，看看他为什么不能满足"),a("strong",[t._v("快速响应")]),t._v("的理念，以至于被重构。")])]),a("h4",{attrs:{id:"react15架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react15架构"}},[t._v("#")]),t._v(" React15架构")]),t._v(" "),a("p",[t._v("React15架构可以分为两层：")]),t._v(" "),a("ul",[a("li",[t._v("Reconciler（协调器）—— 负责找出变化的组件")]),t._v(" "),a("li",[t._v("Renderer（渲染器）—— 负责将变化的组件渲染到页面上")])]),t._v(" "),a("h5",{attrs:{id:"reconciler-协调器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reconciler-协调器"}},[t._v("#")]),t._v(" Reconciler（协调器）")]),t._v(" "),a("p",[t._v("我们知道，在"),a("code",[t._v("React")]),t._v("中可以通过"),a("code",[t._v("this.setState")]),t._v("、"),a("code",[t._v("this.forceUpdate")]),t._v("、"),a("code",[t._v("ReactDOM.render")]),t._v("等API触发更新。")]),t._v(" "),a("p",[t._v("每当有更新发生时，"),a("strong",[t._v("Reconciler")]),t._v("会做如下工作：")]),t._v(" "),a("ul",[a("li",[t._v("调用函数组件、或class组件的"),a("code",[t._v("render")]),t._v("方法，将返回的JSX转化为虚拟DOM")]),t._v(" "),a("li",[t._v("将虚拟DOM和上次更新时的虚拟DOM对比")]),t._v(" "),a("li",[t._v("通过对比找出本次更新中变化的虚拟DOM")]),t._v(" "),a("li",[t._v("通知"),a("strong",[t._v("Renderer")]),t._v("将变化的虚拟DOM渲染到页面上")])]),t._v(" "),a("blockquote",[a("p",[t._v("你可以在"),a("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/codebase-overview.html#reconcilers",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),a("OutboundLink")],1),t._v("看到"),a("code",[t._v("React")]),t._v("官方对"),a("strong",[t._v("Reconciler")]),t._v("的解释")])]),t._v(" "),a("h5",{attrs:{id:"renderer-渲染器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#renderer-渲染器"}},[t._v("#")]),t._v(" Renderer（渲染器）")]),t._v(" "),a("p",[t._v("由于"),a("code",[t._v("React")]),t._v("支持跨平台，所以不同平台有不同的"),a("strong",[t._v("Renderer")]),t._v("。我们前端最熟悉的是负责在浏览器环境渲染的"),a("strong",[t._v("Renderer")]),t._v(" —— "),a("a",{attrs:{href:"https://www.npmjs.com/package/react-dom",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReactDOM"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("除此之外，还有：")]),t._v(" "),a("ul",[a("li",[t._v("[ReactNative渲染器，渲染App原生组件")]),t._v(" "),a("li",[t._v("[ReactTest渲染器，渲染出纯Js对象用于测试")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.npmjs.com/package/react-art",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReactArt "),a("OutboundLink")],1),t._v("渲染器，渲染到Canvas, SVG 或 VML (IE8)")])]),t._v(" "),a("p",[t._v("在每次更新发生时，"),a("strong",[t._v("Renderer")]),t._v("接到"),a("strong",[t._v("Reconciler")]),t._v("通知，将变化的组件渲染在当前宿主环境。")]),t._v(" "),a("blockquote",[a("p",[t._v("你可以在"),a("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/codebase-overview.html#renderers",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),a("OutboundLink")],1),t._v("看到"),a("code",[t._v("React")]),t._v("官方对"),a("strong",[t._v("Renderer")]),t._v("的解释")])]),t._v(" "),a("h4",{attrs:{id:"react15架构的缺点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react15架构的缺点"}},[t._v("#")]),t._v(" React15架构的缺点")]),t._v(" "),a("p",[t._v("​\t在"),a("strong",[t._v("Reconciler")]),t._v("中，"),a("code",[t._v("mount")]),t._v("的组件会调用"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/15-stable/src/renderers/dom/shared/ReactDOMComponent.js#L498",target:"_blank",rel:"noopener noreferrer"}},[t._v("mountComponent "),a("OutboundLink")],1),t._v("，"),a("code",[t._v("update")]),t._v("的组件会调用"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/15-stable/src/renderers/dom/shared/ReactDOMComponent.js#L877",target:"_blank",rel:"noopener noreferrer"}},[t._v("updateComponent "),a("OutboundLink")],1),t._v("。这两个方法都会递归更新子组件。")]),t._v(" "),a("h5",{attrs:{id:"递归更新的缺点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#递归更新的缺点"}},[t._v("#")]),t._v(" 递归更新的缺点")]),t._v(" "),a("p",[t._v("​\t由于递归执行，所以更新一旦开始，中途就无法中断。当层级很深时，递归更新时间超过了16ms，用户交互就会卡顿。")]),t._v(" "),a("p",[t._v("​\t在上一节中，我们已经提出了解决办法——用"),a("strong",[t._v("可中断的异步更新")]),t._v("代替"),a("strong",[t._v("同步的更新")]),t._v("。那么React15的架构支持异步更新么？让我们看一个例子：")]),t._v(" "),a("blockquote",[a("p",[t._v("举例")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://codesandbox.io/s/fervent-sutherland-pf7sg?file=/src/App.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("乘法小Demo"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("我用红色标注了更新的步骤。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241445566.png",alt:"更新流程"}})]),t._v(" "),a("p",[t._v("​\t我们可以看到，"),a("strong",[t._v("Reconciler")]),t._v("和"),a("strong",[t._v("Renderer")]),t._v("是交替工作的，当第一个"),a("code",[t._v("li")]),t._v("在页面上已经变化后，第二个"),a("code",[t._v("li")]),t._v("再进入"),a("strong",[t._v("Reconciler")]),t._v("。")]),t._v(" "),a("p",[t._v("​\t由于整个过程都是同步的，所以在用户看来所有DOM是同时更新的。")]),t._v(" "),a("p",[t._v("​\t接下来，让我们模拟一下，如果中途中断更新会怎么样？")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[a("strong",[t._v("注意")])]),t._v(" "),a("p",[t._v("以下是我们模拟中断的情况，实际上"),a("code",[t._v("React15")]),t._v("并不会中断进行中的更新")])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241446056.png",alt:"中断更新流程"}})]),t._v(" "),a("p",[t._v("当第一个"),a("code",[t._v("li")]),t._v("完成更新时中断更新，即步骤3完成后中断更新，此时后面的步骤都还未执行。")]),t._v(" "),a("p",[t._v("用户本来期望"),a("code",[t._v("123")]),t._v("变为"),a("code",[t._v("246")]),t._v("。实际却看见更新不完全的DOM！（即"),a("code",[t._v("223")]),t._v("）")]),t._v(" "),a("p",[t._v("基于这个原因，"),a("code",[t._v("React")]),t._v("决定重写整个架构。")]),t._v(" "),a("h3",{attrs:{id:"新的react架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#新的react架构"}},[t._v("#")]),t._v(" 新的React架构")]),t._v(" "),a("h4",{attrs:{id:"react16架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react16架构"}},[t._v("#")]),t._v(" React16架构")]),t._v(" "),a("p",[t._v("React16架构可以分为三层：")]),t._v(" "),a("ul",[a("li",[t._v("Scheduler（调度器）—— 调度任务的优先级，高优先级任务优先进入"),a("strong",[t._v("Reconciler")])]),t._v(" "),a("li",[t._v("Reconciler（协调器）—— 负责找出变化的组件")]),t._v(" "),a("li",[t._v("Renderer（渲染器）—— 负责将变化的组件渲染到页面上")])]),t._v(" "),a("h4",{attrs:{id:"scheduler-调度器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#scheduler-调度器"}},[t._v("#")]),t._v(" Scheduler(调度器)")]),t._v(" "),a("p",[t._v("​\t既然我们以浏览器是否有剩余时间作为任务中断的标准，那么我们需要一种机制，当浏览器有剩余时间时通知我们。")]),t._v(" "),a("p",[t._v("​\t其实部分浏览器已经实现了这个API，这就是"),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback",target:"_blank",rel:"noopener noreferrer"}},[t._v("requestIdleCallback (opens new window)"),a("OutboundLink")],1),t._v("。但是由于以下因素，"),a("code",[t._v("React")]),t._v("放弃使用：")]),t._v(" "),a("ul",[a("li",[t._v("浏览器兼容性")]),t._v(" "),a("li",[t._v("触发频率不稳定，受很多因素影响。比如当我们的浏览器切换tab之后，之前tab注册的"),a("code",[t._v("requestIdleCallback")]),t._v("触发的频率会变得很低。")])]),t._v(" "),a("p",[t._v("基于以上原因，"),a("code",[t._v("React")]),t._v("实现了功能更完备的"),a("code",[t._v("requestIdleCallback")]),t._v("polyfill，这就是"),a("code",[t._v("Scheduler")]),t._v("。处理在空闲时触发回调的功能外，"),a("code",[t._v("Scheduler")]),t._v("还提供了多种调度优先级供任务设置。")]),t._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/README.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("Scheduler"),a("OutboundLink")],1),t._v("是独立于"),a("code",[t._v("React")]),t._v("的库")])]),t._v(" "),a("h4",{attrs:{id:"reconciler-协调器-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reconciler-协调器-2"}},[t._v("#")]),t._v(" Reconciler（协调器）")]),t._v(" "),a("p",[t._v("在React15中Reconciler是递归处理虚拟DOM的。")]),t._v(" "),a("p",[t._v("而在React16中，更新工作从递归变成了可中断的循环过程。每次循环都会调用"),a("code",[t._v("shouldYield")]),t._v("判断当前是否有剩余时间。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** @noinline */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("workLoopConcurrent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Perform work until Scheduler asks us to yield")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("shouldYield")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    workInProgress "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("performUnitOfWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("那么React16是如何解决中断更新时，DOM渲染不完全的问题？")]),t._v(" "),a("p",[t._v("在React16中，Reconciler和Renderer不再是交替工作。当"),a("code",[t._v("Scheduler")]),t._v("将任务交给"),a("code",[t._v("Reconciler")]),t._v("后，"),a("code",[t._v("Reconciler")]),t._v("会为变化的虚拟DOM打上代表增、删、更新的标记，类似这样：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Placement "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*             */")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000010")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Update "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                */")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" PlacementAndUpdate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*    */")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000110")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Deletion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*              */")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000001000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("blockquote",[a("p",[t._v("全部的标记见"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactSideEffectTags.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("整个"),a("code",[t._v("Scheduler")]),t._v("和"),a("code",[t._v("Reconciler")]),t._v("的工作都会在内存中进行。只有当所有组件都完成"),a("code",[t._v("Reconciler")]),t._v("的工作，才会统一交给"),a("code",[t._v("Renderer")]),t._v("。")]),t._v(" "),a("blockquote",[a("p",[t._v("你可以在"),a("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/codebase-overview.html#fiber-reconciler",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),a("OutboundLink")],1),t._v("看到"),a("code",[t._v("React")]),t._v("官方对React16新"),a("strong",[t._v("Reconciler")]),t._v("的解释")])]),t._v(" "),a("h4",{attrs:{id:"renderer-渲染器-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#renderer-渲染器-2"}},[t._v("#")]),t._v(" Renderer（渲染器）")]),t._v(" "),a("p",[t._v("Renderer根据Reconciler为虚拟DOM打的标记，同步执行对应的DOM操作。")]),t._v(" "),a("p",[t._v("对于"),a("a",{attrs:{href:"https://codesandbox.io/s/fervent-sutherland-pf7sg?file=/src/App.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("乘法小Demo"),a("OutboundLink")],1),t._v("：")]),t._v(" "),a("p",[t._v("在React16架构中整个更新流程为：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241503161.png",alt:"更新流程"}})]),t._v(" "),a("p",[t._v("其中红框中的步骤随时可能由于以下原因被中断：")]),t._v(" "),a("ul",[a("li",[t._v("有其他更高优先级任务需要先更新")]),t._v(" "),a("li",[t._v("当前帧没有剩余时间")])]),t._v(" "),a("p",[t._v("由于红框中的工作都在内存中进行，不会更新页面的DOM，所以即使反复中断，用户也不会看见更新不完全的DOM。")]),t._v(" "),a("blockquote",[a("p",[t._v("实际上，由于"),a("strong",[t._v("Scheduler")]),t._v("和"),a("strong",[t._v("Reconciler")]),t._v("都是平台无关的，所以"),a("code",[t._v("React")]),t._v("为他们单独发了一个包"),a("a",{attrs:{href:"https://www.npmjs.com/package/react-reconciler",target:"_blank",rel:"noopener noreferrer"}},[t._v("react-Reconciler "),a("OutboundLink")],1),t._v("。你可以用这个包自己实现一个"),a("code",[t._v("ReactDOM")])])]),t._v(" "),a("h4",{attrs:{id:"总结-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结-2"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("​\t"),a("code",[t._v("React16")]),t._v("采用新的"),a("code",[t._v("Reconciler")]),t._v("。"),a("code",[t._v("Reconciler")]),t._v("内部采用了"),a("code",[t._v("Fiber")]),t._v("的架构。")]),t._v(" "),a("p",[t._v("​\t那么"),a("code",[t._v("Fiber")]),t._v("是什么？ 他和"),a("code",[t._v("Reconciler")]),t._v("或者说和"),a("code",[t._v("React")]),t._v("之间是什么关系？")]),t._v(" "),a("h3",{attrs:{id:"fiber架构的心智模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fiber架构的心智模型"}},[t._v("#")]),t._v(" Fiber架构的心智模型")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[t._v("​\tReact核心团队成员"),a("a",{attrs:{href:"https://github.com/sebmarkbage/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Sebastian Markbåge"),a("OutboundLink")],1),t._v("（"),a("code",[t._v("React Hooks")]),t._v("的发明者）曾说：我们在"),a("code",[t._v("React")]),t._v("中做的就是践行"),a("code",[t._v("代数效应")]),t._v("（Algebraic Effects）。")]),t._v(" "),a("p",[t._v("那么，"),a("code",[t._v("代数效应")]),t._v("是什么呢？他和"),a("code",[t._v("React")]),t._v("有什么关系呢。")])]),a("h4",{attrs:{id:"什么是代数效应"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是代数效应"}},[t._v("#")]),t._v(" 什么是代数效应")]),t._v(" "),a("p",[a("code",[t._v("代数效应")]),t._v("是"),a("code",[t._v("函数式编程")]),t._v("的一个概念，用于将"),a("code",[t._v("副作用")]),t._v("从"),a("code",[t._v("函数")]),t._v("调用中分离。")]),t._v(" "),a("p",[t._v("接下来我们用"),a("code",[t._v("虚拟的语法")]),t._v("来解释")]),t._v(" "),a("p",[t._v("假设我们有一个函数"),a("code",[t._v("getTotalPicNum")]),t._v("，传入2个"),a("code",[t._v("用户名称")]),t._v("后，分别查找该用户在平台保存的图片数量，最后将图片数量相加后返回。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTotalPicNum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("user1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" picNum1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPicNum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" picNum2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPicNum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" picNum1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" picNum2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("在"),a("code",[t._v("getTotalPicNum")]),t._v("中，我们不关注"),a("code",[t._v("getPicNum")]),t._v("的实现，只在乎“获取到两个数字后将它们相加的结果返回”这一过程。")]),t._v(" "),a("p",[t._v("接下来我们实现"),a("code",[t._v("getPicNum")]),t._v("。")]),t._v(" "),a("p",[t._v("“用户在平台保存的图片数量”是保存在服务器中的， 所以，为了获取该值，我们需要发起异步请求。")]),t._v(" "),a("p",[t._v("为了尽量保持"),a("code",[t._v("getTotalPicNum")]),t._v("的调用方式不变，我们首先想到了使用"),a("code",[t._v("async await")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTotalPicNum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("user1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" picNum1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPicNum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" picNum2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPicNum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" picNum1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" picNum2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("但是，"),a("code",[t._v("async await")]),t._v("是由"),a("code",[t._v("传染性")]),t._v("的： 当一个函数变为"),a("code",[t._v("async")]),t._v("后，这意味着调用它的函数也需要是"),a("code",[t._v("async")]),t._v("，这破坏了"),a("code",[t._v("getTotalPicNum")]),t._v("的同步特性。")]),t._v(" "),a("p",[t._v("有没有什么方法能保持"),a("code",[t._v("getTotalPicNum")]),t._v("保持现有调用方式不变的情况下实现异步请求呢？")]),t._v(" "),a("p",[t._v("没有。不过我们可以"),a("code",[t._v("虚构")]),t._v("一个")]),t._v(" "),a("p",[t._v("我们虚构一个类似"),a("code",[t._v("try...catch")]),t._v("的语法 —— "),a("code",[t._v("try...handle")]),t._v("与两个操作符"),a("code",[t._v("perform")]),t._v("、"),a("code",[t._v("resume")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPicNum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" picNum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" perform name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" picNum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTotalPicNum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kaSong'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xiaoMing'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handle")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("who")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("who"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kaSong'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      resume "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("230")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xiaoMing'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      resume "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("122")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      resume "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br")])]),a("p",[t._v("当执行到"),a("code",[t._v("getTotalPicNum")]),t._v("内部的"),a("code",[t._v("getPicNum")]),t._v("方法时，会执行"),a("code",[t._v("perform name")]),t._v("。")]),t._v(" "),a("p",[t._v("此时函数调用栈会从"),a("code",[t._v("getPicNum")]),t._v("方法内跳出，被最近一个"),a("code",[t._v("try...handle")]),t._v("捕获。类似"),a("code",[t._v("throw Error")]),t._v("后被最近一个"),a("code",[t._v("try...catch")]),t._v("捕获。")]),t._v(" "),a("p",[t._v("类似"),a("code",[t._v("throw Error")]),t._v("后"),a("code",[t._v("Error")]),t._v("会作为"),a("code",[t._v("catch")]),t._v("的参数，"),a("code",[t._v("perform name")]),t._v("后"),a("code",[t._v("name")]),t._v("会作为"),a("code",[t._v("handle")]),t._v("的参数。")]),t._v(" "),a("p",[t._v("与"),a("code",[t._v("try...catch")]),t._v("最大的不同在于：当"),a("code",[t._v("Error")]),t._v("被"),a("code",[t._v("catch")]),t._v("捕获后，之前的调用栈就销毁了。而"),a("code",[t._v("handle")]),t._v("执行"),a("code",[t._v("resume")]),t._v("后会回到之前"),a("code",[t._v("perform")]),t._v("的调用栈。")]),t._v(" "),a("p",[t._v("对于"),a("code",[t._v("case 'kaSong'")]),t._v("，执行完"),a("code",[t._v("resume with 230;")]),t._v("后调用栈会回到"),a("code",[t._v("getPicNum")]),t._v("，此时"),a("code",[t._v("picNum === 230")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[a("strong",[t._v("注意")])]),t._v(" "),a("p",[t._v("再次申明，"),a("code",[t._v("try...handle")]),t._v("的语法是虚构的，只是为了演示"),a("code",[t._v("代数效应")]),t._v("的思想。")])]),a("p",[t._v("总结一下："),a("code",[t._v("代数效应")]),t._v("能够将"),a("code",[t._v("副作用")]),t._v("（例子中为"),a("code",[t._v("请求图片数量")]),t._v("）从函数逻辑中分离，使函数关注点保持纯粹。")]),t._v(" "),a("p",[t._v("并且，从例子中可以看出，"),a("code",[t._v("perform resume")]),t._v("不需要区分同步异步。")]),t._v(" "),a("h4",{attrs:{id:"代数效应在react中的应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#代数效应在react中的应用"}},[t._v("#")]),t._v(" 代数效应在React中的应用")]),t._v(" "),a("p",[t._v("那么"),a("code",[t._v("代数效应")]),t._v("与"),a("code",[t._v("React")]),t._v("有什么关系呢？最明显的例子就是"),a("code",[t._v("Hooks")]),t._v("。")]),t._v(" "),a("p",[t._v("对于类似"),a("code",[t._v("useState")]),t._v("、"),a("code",[t._v("useReducer")]),t._v("、"),a("code",[t._v("useRef")]),t._v("这样的"),a("code",[t._v("Hook")]),t._v("，我们不需要关注"),a("code",[t._v("FunctionComponent")]),t._v("的"),a("code",[t._v("state")]),t._v("在"),a("code",[t._v("Hook")]),t._v("中是如何保存的，"),a("code",[t._v("React")]),t._v("会为我们处理。")]),t._v(" "),a("p",[t._v("我们只需要假设"),a("code",[t._v("useState")]),t._v("返回的是我们想要的"),a("code",[t._v("state")]),t._v("，并编写业务逻辑就行。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" updateNum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button onClick"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateNum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("num")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" num "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("  \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("如果这个例子还不够明显，可以看看官方的"),a("a",{attrs:{href:"https://codesandbox.io/s/frosty-hermann-bztrp?file=/src/index.js:152-160",target:"_blank",rel:"noopener noreferrer"}},[t._v("Suspense Demo"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("Demo")]),t._v("中"),a("code",[t._v("ProfileDetails")]),t._v("用于展示"),a("code",[t._v("用户名称")]),t._v("。而"),a("code",[t._v("用户名称")]),t._v("是"),a("code",[t._v("异步请求")]),t._v("的。")]),t._v(" "),a("p",[t._v("但是"),a("code",[t._v("Demo")]),t._v("中完全是"),a("code",[t._v("同步")]),t._v("的写法。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ProfileDetails")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" resource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("h1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("h1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("h4",{attrs:{id:"代数效应与generator"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#代数效应与generator"}},[t._v("#")]),t._v(" 代数效应与"),a("code",[t._v("Generator")])]),t._v(" "),a("p",[t._v("从"),a("code",[t._v("React15")]),t._v("到"),a("code",[t._v("React16")]),t._v("，协调器（"),a("code",[t._v("Reconciler")]),t._v("）重构的一大目的是：将老的"),a("code",[t._v("同步更新")]),t._v("的架构变为"),a("code",[t._v("异步可中断更新")]),t._v("。")]),t._v(" "),a("p",[a("code",[t._v("异步可中断更新")]),t._v("可以理解为："),a("code",[t._v("更新")]),t._v("在执行过程中可能会被打断（浏览器时间分片用尽或有更高优任务插队），当可以继续执行时恢复之前执行的中间状态。")]),t._v(" "),a("p",[t._v("这就是"),a("code",[t._v("代数效应")]),t._v("中"),a("code",[t._v("try...handle")]),t._v("的作用。")]),t._v(" "),a("p",[t._v("其实，浏览器原生就支持类似的实现，这就是"),a("code",[t._v("Generator")]),t._v("。")]),t._v(" "),a("p",[t._v("但是"),a("code",[t._v("Generator")]),t._v("的一些缺陷使"),a("code",[t._v("React")]),t._v("团队放弃了他：")]),t._v(" "),a("ul",[a("li",[t._v("类似"),a("code",[t._v("async")]),t._v("，"),a("code",[t._v("Generator")]),t._v("也是"),a("code",[t._v("传染性")]),t._v("的，使用了"),a("code",[t._v("Generator")]),t._v("则上下文的其他函数也需要作出改变。这样心智负担比较重。")]),t._v(" "),a("li",[a("code",[t._v("Generator")]),t._v("执行的"),a("code",[t._v("中间状态")]),t._v("是上下文关联的。")])]),t._v(" "),a("p",[t._v("考虑如下例子：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("B")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("C")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" x "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doExpensiveWorkA")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("A")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("yield")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" y "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" x "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doExpensiveWorkB")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("B")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("yield")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" z "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" y "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doExpensiveWorkC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("C")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" z"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("每当浏览器有空闲时间都会依次执行其中一个"),a("code",[t._v("doExpensiveWork")]),t._v("，当时间用尽则会中断，当再次恢复时会从中断位置继续执行。")]),t._v(" "),a("p",[t._v("只考虑“单一优先级任务的中断与继续”情况下"),a("code",[t._v("Generator")]),t._v("可以很好的实现"),a("code",[t._v("异步可中断更新")]),t._v("。")]),t._v(" "),a("p",[t._v("但是当我们考虑“高优先级任务插队”的情况，如果此时已经完成"),a("code",[t._v("doExpensiveWorkA")]),t._v("与"),a("code",[t._v("doExpensiveWorkB")]),t._v("计算出"),a("code",[t._v("x")]),t._v("与"),a("code",[t._v("y")]),t._v("。")]),t._v(" "),a("p",[t._v("此时"),a("code",[t._v("B")]),t._v("组件接收到一个"),a("code",[t._v("高优更新")]),t._v("，由于"),a("code",[t._v("Generator")]),t._v("执行的"),a("code",[t._v("中间状态")]),t._v("是上下文关联的，所以计算"),a("code",[t._v("y")]),t._v("时无法复用之前已经计算出的"),a("code",[t._v("x")]),t._v("，需要重新计算。")]),t._v(" "),a("p",[t._v("如果通过"),a("code",[t._v("全局变量")]),t._v("保存之前执行的"),a("code",[t._v("中间状态")]),t._v("，又会引入新的复杂度。")]),t._v(" "),a("blockquote",[a("p",[t._v("更详细的解释可以参考"),a("a",{attrs:{href:"https://github.com/facebook/react/issues/7942#issuecomment-254987818",target:"_blank",rel:"noopener noreferrer"}},[t._v("这个issue"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("基于这些原因，"),a("code",[t._v("React")]),t._v("没有采用"),a("code",[t._v("Generator")]),t._v("实现"),a("code",[t._v("协调器")]),t._v("。")]),t._v(" "),a("h4",{attrs:{id:"代数效应与fiber"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#代数效应与fiber"}},[t._v("#")]),t._v(" 代数效应与Fiber")]),t._v(" "),a("p",[a("code",[t._v("Fiber")]),t._v("并不是计算机术语中的新名词，他的中文翻译叫做"),a("code",[t._v("纤程")]),t._v("，与进程（Process）、线程（Thread）、协程（Coroutine）同为程序执行过程。")]),t._v(" "),a("p",[t._v("在很多文章中将"),a("code",[t._v("纤程")]),t._v("理解为"),a("code",[t._v("协程")]),t._v("的一种实现。在"),a("code",[t._v("JS")]),t._v("中，"),a("code",[t._v("协程")]),t._v("的实现便是"),a("code",[t._v("Generator")]),t._v("。")]),t._v(" "),a("p",[t._v("所以，我们可以将"),a("code",[t._v("纤程")]),t._v("(Fiber)、"),a("code",[t._v("协程")]),t._v("(Generator)理解为"),a("code",[t._v("代数效应")]),t._v("思想在"),a("code",[t._v("JS")]),t._v("中的体现。")]),t._v(" "),a("p",[a("strong",[a("code",[t._v("React Fiber")])]),t._v("："),a("code",[t._v("React")]),t._v("内部实现的一套状态更新机制。支持任务不同"),a("code",[t._v("优先级")]),t._v("，可中断与恢复，并且恢复后可以复用之前的"),a("code",[t._v("中间状态")]),t._v("。")]),t._v(" "),a("p",[t._v("其中每个任务更新单元为"),a("code",[t._v("React Element")]),t._v("对应的"),a("code",[t._v("Fiber节点")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"fiber架构的实现原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fiber架构的实现原理"}},[t._v("#")]),t._v(" Fiber架构的实现原理")]),t._v(" "),a("h4",{attrs:{id:"fiber的起源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fiber的起源"}},[t._v("#")]),t._v(" Fiber的起源")]),t._v(" "),a("blockquote",[a("p",[t._v("最早的"),a("code",[t._v("Fiber")]),t._v("官方解释来源于"),a("a",{attrs:{href:"https://github.com/acdlite/react-fiber-architecture",target:"_blank",rel:"noopener noreferrer"}},[t._v("2016年React团队成员Acdlite的一篇介绍"),a("OutboundLink")],1),t._v("。")])]),t._v(" "),a("p",[t._v("​\t在"),a("code",[t._v("React15")]),t._v("及以前，"),a("code",[t._v("Reconciler")]),t._v("采用递归的方式创建虚拟DOM，递归过程是不能中断的。如果组件树的层级很深，递归会占用线程很多时间，造成卡顿。")]),t._v(" "),a("p",[t._v("​\t为了解决这个问题，"),a("code",[t._v("React16")]),t._v("将递归的无法中断的更新重构为异步的可中断更新，由于曾经用于递归的 "),a("strong",[t._v("虚拟DOM")]),t._v("数据结构已经无法满足需要，于是，全新的"),a("code",[t._v("Fiber")]),t._v("架构应运而生。")]),t._v(" "),a("h4",{attrs:{id:"fiber的含义"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fiber的含义"}},[t._v("#")]),t._v(" Fiber的含义")]),t._v(" "),a("ol",[a("li",[t._v("作为架构来说，之前"),a("code",[t._v("React15")]),t._v("的"),a("code",[t._v("Reconciler")]),t._v("采用递归的方式执行，数据保存在递归调用栈中，所以被称为"),a("code",[t._v("stack Reconciler")]),t._v("。"),a("code",[t._v("React16")]),t._v("的"),a("code",[t._v("Reconciler")]),t._v("基于"),a("code",[t._v("Fiber节点")]),t._v("实现，被称为"),a("code",[t._v("Fiber Reconciler")]),t._v("。")]),t._v(" "),a("li",[t._v("作为静态的数据结构来说，每个"),a("code",[t._v("Fiber节点")]),t._v("对应一个"),a("code",[t._v("React element")]),t._v("，保存了该组件的类型（函数组件/类组件/原生组件...）、对应的DOM节点等信息。")]),t._v(" "),a("li",[t._v("作为动态的工作单元来说，每个"),a("code",[t._v("Fiber节点")]),t._v("保存了本次更新中该组件改变的状态、要执行的工作（需要被删除/被插入页面中/被更新...）。")])]),t._v(" "),a("h4",{attrs:{id:"fiber的结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fiber的结构"}},[t._v("#")]),t._v(" Fiber的结构")]),t._v(" "),a("p",[t._v("你可以从这里看到"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiber.new.js#L117",target:"_blank",rel:"noopener noreferrer"}},[t._v("Fiber节点的属性定义"),a("OutboundLink")],1),t._v("。虽然属性很多，但我们可以按三层含义将他们分类来看。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FiberNode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" WorkTag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("pendingProps")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mixed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("key")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("mode")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" TypeOfMode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 作为静态数据结构的属性")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elementType "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stateNode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用于连接其他Fiber节点形成Fiber树")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("return "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("child "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sibling "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("index "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ref "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 作为动态的工作单元的属性")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pendingProps "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pendingProps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedProps "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateQueue "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dependencies "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("effectTag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoEffect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nextEffect "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firstEffect "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lastEffect "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调度优先级相关")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoLanes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("childLanes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoLanes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指向该fiber在另一次更新时对应的fiber")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alternate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br")])]),a("h5",{attrs:{id:"作为架构来说"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#作为架构来说"}},[t._v("#")]),t._v(" 作为架构来说")]),t._v(" "),a("p",[t._v("每个Fiber节点有个对应的"),a("code",[t._v("React element")]),t._v("，多个"),a("code",[t._v("Fiber节点")]),t._v("是如何连接形成树呢？靠如下三个属性：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指向父级Fiber节点")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("return "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指向子Fiber节点")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("child "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指向右边第一个兄弟Fiber节点")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sibling "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("举个例子，如下的组件结构：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n      i am\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("span"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("KaSong"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("span"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("对应的"),a("code",[t._v("Fiber树")]),t._v("结构")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241551075.png",alt:"Fiber架构"}})]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[a("strong",[t._v("问题")]),t._v("： 为什么父级指针叫做"),a("code",[t._v("return")]),t._v("而不是"),a("code",[t._v("parent")]),t._v("或者"),a("code",[t._v("father")]),t._v("呢？")]),t._v(" "),a("p",[a("strong",[t._v("答")]),t._v("： 因为作为一个工作单元，"),a("code",[t._v("return")]),t._v("指节点执行完"),a("code",[t._v("completeWork")]),t._v("后会返回的下一个节点。子"),a("code",[t._v("Fiber节点")]),t._v("及其兄弟节点完成工作后会返回其父级节点，所以用"),a("code",[t._v("return")]),t._v("指代父级节点。")])]),a("h5",{attrs:{id:"作为静态的数据结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#作为静态的数据结构"}},[t._v("#")]),t._v(" 作为静态的数据结构")]),t._v(" "),a("p",[t._v("作为一种静态的数据结构,保存了组件的相关信息：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Fiber对应组件的类型 Function/Class/Host...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// key属性")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 大部分情况同type，某些情况不同，比如FunctionComponent使用React.memo包裹")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elementType "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 对于 FunctionComponent，指函数本身，对于ClassComponent，指class，对于HostComponent，指DOM节点tagName")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Fiber对应的真实DOM节点")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stateNode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("h5",{attrs:{id:"作为动态的工作单元"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#作为动态的工作单元"}},[t._v("#")]),t._v(" 作为动态的工作单元")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 保存本次更新造成的状态改变相关信息")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pendingProps "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pendingProps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedProps "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateQueue "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dependencies "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 保存本次更新会造成的DOM操作")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("effectTag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoEffect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nextEffect "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firstEffect "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lastEffect "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调度优先级相关")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoLanes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("childLanes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoLanes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br")])]),a("h4",{attrs:{id:"总结-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结-3"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("​\t"),a("code",[t._v("Fiber节点")]),t._v("可以构成"),a("code",[t._v("Fiber树")]),t._v("。")]),t._v(" "),a("p",[t._v("​\t那么"),a("code",[t._v("Fiber树")]),t._v("与页面呈现的"),a("code",[t._v("DOM")]),t._v("树有什么关系，"),a("code",[t._v("React")]),t._v("又是如何更新"),a("code",[t._v("DOM")]),t._v("的呢？")]),t._v(" "),a("h4",{attrs:{id:"fiber架构的工作原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fiber架构的工作原理"}},[t._v("#")]),t._v(" Fiber架构的工作原理")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[t._v("​\t"),a("code",[t._v("Fiber节点")]),t._v("可以保存对应的"),a("code",[t._v("DOM节点")]),t._v("。")]),t._v(" "),a("p",[t._v("​\t相应的，"),a("code",[t._v("Fiber节点")]),t._v("构成的"),a("code",[t._v("Fiber树")]),t._v("就对应"),a("code",[t._v("DOM树")]),t._v("。")]),t._v(" "),a("p",[t._v("​\t那如何更新"),a("code",[t._v("DOM")]),t._v("呢？这需要用到被称为“双缓存”的技术。")])]),a("h5",{attrs:{id:"什么是-双缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是-双缓存"}},[t._v("#")]),t._v(" 什么是“双缓存”")]),t._v(" "),a("p",[t._v("​\t当我们用"),a("code",[t._v("canvas")]),t._v("绘制动画，每一帧绘制前都会调用"),a("code",[t._v("ctx.clearRect")]),t._v("清除上一帧的画面。")]),t._v(" "),a("p",[t._v("​\t如果当前帧画面计算量比较大，导致清除上一帧画面到绘制当前帧画面之间有较长间隙，就会出现白屏。")]),t._v(" "),a("p",[t._v("​\t为了解决这个问题，我们可以在内存中绘制当前帧动画，绘制完毕后直接用当前帧替换上一帧画面，由于省去了两帧替换间的计算时间，不会出现从白屏到出现画面的闪烁情况。")]),t._v(" "),a("p",[t._v("​\t这种"),a("strong",[t._v("在内存中构建并直接替换")]),t._v("的技术叫做"),a("a",{attrs:{href:"https://baike.baidu.com/item/%E5%8F%8C%E7%BC%93%E5%86%B2",target:"_blank",rel:"noopener noreferrer"}},[t._v("双缓存 "),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("​\t"),a("code",[t._v("React")]),t._v("使用“双缓存”来完成"),a("code",[t._v("Fiber树")]),t._v("的构建与替换——对应着"),a("code",[t._v("DOM树")]),t._v("的创建与更新。")]),t._v(" "),a("h5",{attrs:{id:"双缓存fiber树"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#双缓存fiber树"}},[t._v("#")]),t._v(" 双缓存Fiber树")]),t._v(" "),a("p",[t._v("​\t在"),a("code",[t._v("React")]),t._v("中最多会同时存在两棵"),a("code",[t._v("Fiber树")]),t._v("。当前屏幕上显示内容对应的"),a("code",[t._v("Fiber树")]),t._v("称为"),a("code",[t._v("current Fiber树")]),t._v("，正在内存中构建的"),a("code",[t._v("Fiber树")]),t._v("称为"),a("code",[t._v("workInProgress Fiber树")]),t._v("。")]),t._v(" "),a("p",[t._v("​\t"),a("code",[t._v("current Fiber树")]),t._v("中的"),a("code",[t._v("Fiber节点")]),t._v("被称为"),a("code",[t._v("current fiber")]),t._v("，"),a("code",[t._v("workInProgress Fiber树")]),t._v("中的"),a("code",[t._v("Fiber节点")]),t._v("被称为"),a("code",[t._v("workInProgress fiber")]),t._v("，他们通过"),a("code",[t._v("alternate")]),t._v("属性连接。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("currentFiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alternate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" workInProgressFiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworkInProgressFiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alternate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" currentFiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("​\t"),a("code",[t._v("React")]),t._v("应用的根节点通过使"),a("code",[t._v("current")]),t._v("指针在不同"),a("code",[t._v("Fiber树")]),t._v("的"),a("code",[t._v("rootFiber")]),t._v("间切换来完成"),a("code",[t._v("current Fiber")]),t._v("树指向的切换。")]),t._v(" "),a("p",[t._v("​\t即当"),a("code",[t._v("workInProgress Fiber树")]),t._v("构建完成交给"),a("code",[t._v("Renderer")]),t._v("渲染在页面上后，应用根节点的"),a("code",[t._v("current")]),t._v("指针指向"),a("code",[t._v("workInProgress Fiber树")]),t._v("，此时"),a("code",[t._v("workInProgress Fiber树")]),t._v("就变为"),a("code",[t._v("current Fiber树")]),t._v("。")]),t._v(" "),a("p",[t._v("​\t每次状态更新都会产生新的"),a("code",[t._v("workInProgress Fiber树")]),t._v("，通过"),a("code",[t._v("current")]),t._v("与"),a("code",[t._v("workInProgress")]),t._v("的替换，完成"),a("code",[t._v("DOM")]),t._v("更新。")]),t._v(" "),a("h5",{attrs:{id:"mount时"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mount时"}},[t._v("#")]),t._v(" mount时")]),t._v(" "),a("p",[t._v("考虑以下例子")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" add"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("p onClick"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("p"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nReactDOM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("App"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("ol",[a("li",[t._v("首次执行"),a("code",[t._v("ReactDOM.render")]),t._v("会创建"),a("code",[t._v("fiberRootNode")]),t._v("和"),a("code",[t._v("rootFiber")]),t._v("。其中"),a("code",[t._v("fiberRootNode")]),t._v("是整个应用的根节点，"),a("code",[t._v("rootFiber")]),t._v("是"),a("code",[t._v("<App/>")]),t._v("所在组件树的根节点。")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[a("strong",[t._v("问")]),t._v("： 为什么要区分"),a("code",[t._v("fiberRootNode")]),t._v("与"),a("code",[t._v("rootFiber")])]),t._v(" "),a("p",[a("strong",[t._v("答")]),t._v("： 因为在应用中我们可以多次调用"),a("code",[t._v("ReactDOM.render")]),t._v("渲染不同的组件树，它们会拥有不同的"),a("code",[t._v("rootFiber")]),t._v("。但是整个应用的根节点只有一个，那就是"),a("code",[t._v("fiberRootNode")]),t._v("。")]),t._v(" "),a("p",[t._v("​\t"),a("code",[t._v("fiberRootNode")]),t._v("的"),a("code",[t._v("current")]),t._v("会指向当前页面上已渲染内容对应"),a("code",[t._v("Fiber树")]),t._v("，即"),a("code",[t._v("current Fiber树")]),t._v("。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241629069.png",alt:"rootFiber"}})]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("fiberRootNode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rootFiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("由于是首屏渲染，页面中还没有挂载任何"),a("code",[t._v("DOM")]),t._v("，所以"),a("code",[t._v("fiberRootNode.current")]),t._v("指向的"),a("code",[t._v("rootFiber")]),t._v("没有任何"),a("code",[t._v("子Fiber节点")]),t._v("（即"),a("code",[t._v("current Fiber树")]),t._v("为空）。")])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("接下来进入"),a("code",[t._v("render阶段")]),t._v("，根据组件返回的"),a("code",[t._v("JSX")]),t._v("在内存中依次创建"),a("code",[t._v("Fiber节点")]),t._v("并连接在一起构建"),a("code",[t._v("Fiber树")]),t._v("，被称为"),a("code",[t._v("workInPrigress Fiber树")]),t._v("。")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[t._v("​\t在构建"),a("code",[t._v("workInProgress Fiber树")]),t._v("时会尝试复用"),a("code",[t._v("current Fiber树")]),t._v("中已有的"),a("code",[t._v("Fiber节点")]),t._v("内的属性，在"),a("code",[t._v("首屏渲染")]),t._v("时只有"),a("code",[t._v("rootFiber")]),t._v("存在对应的"),a("code",[t._v("current fiber")]),t._v("（即"),a("code",[t._v("rootFiber.alternate")]),t._v("）。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241632932.png",alt:"workInProgressFiber"}})])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("已构建完的"),a("code",[t._v("workInProgress Fiber树")]),t._v("在"),a("code",[t._v("commit阶段")]),t._v("渲染到页面。")])]),t._v(" "),a("p",[t._v("此时"),a("code",[t._v("DOM")]),t._v("更新为右侧树对应的样子。"),a("code",[t._v("fiberRootNode")]),t._v("的"),a("code",[t._v("current")]),t._v("指针指向"),a("code",[t._v("workInProgress Fiber树")]),t._v("使其变为"),a("code",[t._v("current Fiber 树")]),t._v("。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241634013.png",alt:"workInProgressFiberFinish"}})]),t._v(" "),a("h5",{attrs:{id:"update时"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#update时"}},[t._v("#")]),t._v(" update时")]),t._v(" "),a("ol",[a("li",[t._v("接下来我们点击"),a("code",[t._v("p节点")]),t._v("触发状态改变，这会开启依次新的"),a("code",[t._v("render阶段")]),t._v("并构建一颗新的"),a("code",[t._v("workInProgress Fiber树")]),t._v("。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241636330.png",alt:"wipTreeUpdate"}})]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[t._v("​\t和"),a("code",[t._v("mount")]),t._v("时一样，"),a("code",[t._v("workInProgress fiber")]),t._v("的创建可以复用"),a("code",[t._v("current Fiber树")]),t._v("对应的节点数据。")]),t._v(" "),a("p",[t._v("​\t这个决定是否复用的过程就是Diff算法。")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("code",[t._v("workInProgress Fiber树")]),t._v("在"),a("code",[t._v("render阶段")]),t._v("完成构建后进入"),a("code",[t._v("commit阶段")]),t._v("渲染到页面上。渲染完毕后， "),a("code",[t._v("workInProgress Fiber树")]),t._v("变为"),a("code",[t._v("current Fiber树")]),t._v("。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/option-star/imgs/202204241639575.png",alt:"currentTreeUpdate"}})]),t._v(" "),a("h2",{attrs:{id:"第二章-前置知识"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第二章-前置知识"}},[t._v("#")]),t._v(" 第二章 前置知识")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[a("code",[t._v("React16")]),t._v("的架构分为三层：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Scheduler(调度器)")]),t._v("： 调度任务的优先级，高优先级的任务优先进入Reconciler")]),t._v(" "),a("li",[a("code",[t._v("Reconciler(协调器)")]),t._v("：负责找出变化的组件")]),t._v(" "),a("li",[a("code",[t._v("Renderer(渲染器)")]),t._v("：负责将变化的组件渲染到页面上")])])]),a("h3",{attrs:{id:"源码目录结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#源码目录结构"}},[t._v("#")]),t._v(" 源码目录结构")]),t._v(" "),a("h4",{attrs:{id:"顶层目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#顶层目录"}},[t._v("#")]),t._v(" 顶层目录")]),t._v(" "),a("p",[t._v("除去配置文件和隐藏文件夹，根目录的文件夹包括三个：")]),t._v(" "),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("根目录\n├── fixtures        # 包含一些给贡献者准备的小型 React 测试项目\n├── packages        # 包含元数据（比如 package.json）和 React 仓库中所有 package 的源码（子目录 src）\n├── scripts         # 各种工具链的脚本，比如git、jest、eslint等\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("这里我们关注"),a("strong",[t._v("packages")]),t._v("目录")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("fixtures")]),t._v(": 包含一些给贡献者准备的小型 React 测试项目")]),t._v(" "),a("li",[a("code",[t._v("packages")]),t._v(": 包含元数据（比如 package.json）和 React 仓库中所有 package 的源码（子目录 src）")]),t._v(" "),a("li",[a("code",[t._v("scripts")]),t._v(": 各种工具链的脚本，比如git、jest、eslint等")])]),t._v(" "),a("h4",{attrs:{id:"packages目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#packages目录"}},[t._v("#")]),t._v(" packages目录")]),t._v(" "),a("ul",[a("li",[a("p",[a("strong",[t._v("react")]),t._v(": 包含所有全局React API")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("scheduler")]),t._v("： "),a("code",[t._v("Scheduler")]),t._v("(调度器)的实现")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("shared")]),t._v(": 包含公共的方法和全局变量")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("Renderer")]),t._v("相关文件夹")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("react-art")])]),t._v(" "),a("li",[a("strong",[t._v("react-dom")]),t._v(": 同时使DOM和SSR的入口")]),t._v(" "),a("li",[a("strong",[t._v("react-native-renderer")])]),t._v(" "),a("li",[a("strong",[t._v("react-noop-renderer")]),t._v("： 用于"),a("code",[t._v("debug fiber")])]),t._v(" "),a("li",[a("strong",[t._v("react-test-renderer")])])])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("实验性包的文件夹")])]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("react-server")]),t._v(": 创建自定义SSR流")]),t._v(" "),a("li",[a("strong",[t._v("react-client")]),t._v(": 创建自定义的流")]),t._v(" "),a("li",[a("strong",[t._v("react-fetch")]),t._v(": 用于数据请求")]),t._v(" "),a("li",[a("strong",[t._v("react-interactions")]),t._v(": 用于测试交互相关的内部特性，比如React的事件模型")]),t._v(" "),a("li",[a("strong",[t._v("react-reconciler")]),t._v(": Reconciler的实现，你可以用他构建自己的Renderer")])])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("辅助包的文件夹")])]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("react-is")]),t._v(" : 用于测试组件是否是某类型")]),t._v(" "),a("li",[a("strong",[t._v("react-client")]),t._v(": 创建自定义的流")]),t._v(" "),a("li",[a("strong",[t._v("react-fetch")]),t._v(": 用于数据请求")]),t._v(" "),a("li",[a("strong",[t._v("react-refresh")]),t._v(": “热重载”的react官方实现")])])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("react-reconciler")]),t._v(": 一边对接"),a("code",[t._v("Scheduler")]),t._v("，一边对接不同平台的"),a("code",[t._v("Renderer")])])])]),t._v(" "),a("h3",{attrs:{id:"深入理解jsx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#深入理解jsx"}},[t._v("#")]),t._v(" 深入理解JSX")]),t._v(" "),a("h4",{attrs:{id:"jsx简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jsx简介"}},[t._v("#")]),t._v(" JSX简介")]),t._v(" "),a("p",[t._v("​\t"),a("code",[t._v("JSX")]),t._v("在编译时会被"),a("code",[t._v("Babel")]),t._v("编译为"),a("code",[t._v("React.createElement")]),t._v("方法。这也是为什么在每个使用"),a("code",[t._v("JSX")]),t._v("的JS文件中，你必须显式的声明否则在运行时该模块内就会报"),a("code",[t._v("未定义变量 React")]),t._v("的错误。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'react'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h4",{attrs:{id:"react-createelement"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react-createelement"}},[t._v("#")]),t._v(" "),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react/src/ReactElement.js#L348",target:"_blank",rel:"noopener noreferrer"}},[t._v("React.createElement"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("既然"),a("code",[t._v("JSX")]),t._v("会被编译为"),a("code",[t._v("React.createElement")]),t._v("，让我们看看他做了什么：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" children")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" propName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" props "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" ref "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" self "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" source "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将 config 处理后赋值给 props")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" childrenLength "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" arguments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理 children，会被赋值给props.children")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理 defaultProps")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ReactElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ref"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ReactCurrentOwner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    props"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("ReactElement")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ref"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" owner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" props")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" element "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 标记这是个 React Element")]),t._v("\n    $$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REACT_ELEMENT_TYPE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("key")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ref")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ref"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("props")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" props"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_owner")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" owner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br")])]),a("p",[t._v("我们可以看到，"),a("code",[t._v("React.createElement")]),t._v("最终会调用"),a("code",[t._v("ReactElement")]),t._v("方法返回一个包含组件数据的对象，该对象有个参数"),a("code",[t._v("$$typeof: REACT_ELEMENT_TYPE")]),t._v("标记了该对象是个"),a("code",[t._v("React Element")]),t._v("。")]),t._v(" "),a("p",[t._v("所以调用"),a("code",[t._v("React.createElement")]),t._v("返回的对象就是"),a("code",[t._v("React Element")]),t._v("么？")]),t._v(" "),a("p",[a("code",[t._v("React")]),t._v("提供了验证合法"),a("code",[t._v("React Element")]),t._v("的全局API "),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react/src/ReactElement.js#L547",target:"_blank",rel:"noopener noreferrer"}},[t._v("React.isValidElement (opens new window)"),a("OutboundLink")],1),t._v("，我们看下他的实现：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isValidElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("object")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" object "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'object'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    object "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REACT_ELEMENT_TYPE")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("可以看到，"),a("code",[t._v("$$typeof === REACT_ELEMENT_TYPE")]),t._v("的非"),a("code",[t._v("null")]),t._v("对象就是一个合法的"),a("code",[t._v("React Element")]),t._v("。换言之，在"),a("code",[t._v("React")]),t._v("中，所有"),a("code",[t._v("JSX")]),t._v("在运行时的返回结果（即"),a("code",[t._v("React.createElement()")]),t._v("的返回值）都是"),a("code",[t._v("React Element")]),t._v("。")]),t._v(" "),a("p",[t._v("那么"),a("code",[t._v("JSX")]),t._v("和"),a("code",[t._v("React Component")]),t._v("的关系呢?")]),t._v(" "),a("h4",{attrs:{id:"react-component"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react-component"}},[t._v("#")]),t._v(" React Component")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("React")]),t._v("中，我们常使用"),a("code",[t._v("ClassComponent")]),t._v("与"),a("code",[t._v("FunctionComponent")]),t._v("构建组件。")]),t._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AppClass")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("KaSong")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'这是ClassComponent：'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" AppClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'这是Element：'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AppClass")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AppFunc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("KaSong")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'这是FunctionComponent：'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" AppFunc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'这是Element：'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AppFunc")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("p",[t._v("我们可以从Demo控制台打印的对象看出，"),a("code",[t._v("ClassComponent")]),t._v("对应的"),a("code",[t._v("Element")]),t._v("的"),a("code",[t._v("type")]),t._v("字段为"),a("code",[t._v("AppClass")]),t._v("自身。")]),t._v(" "),a("p",[a("code",[t._v("FunctionComponent")]),t._v("对应的"),a("code",[t._v("Element")]),t._v("的"),a("code",[t._v("type")]),t._v("字段为"),a("code",[t._v("AppFunc")]),t._v("自身，如下所示：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  $$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Symbol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("react"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("key")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("props")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ref")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ƒ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AppFunc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_owner")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_store")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("validated")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_self")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_source")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("p",[t._v("值得注意的一点，由于")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("AppClass "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nAppFunc "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("所以无法通过引用类型区分"),a("code",[t._v("ClassComponent")]),t._v("和"),a("code",[t._v("FunctionComponent")]),t._v("。"),a("code",[t._v("React")]),t._v("通过"),a("code",[t._v("ClassComponent")]),t._v("实例原型上的"),a("code",[t._v("isReactComponent")]),t._v("变量判断是否是"),a("code",[t._v("ClassComponent")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClassComponent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isReactComponent "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h4",{attrs:{id:"jsx与fiber节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jsx与fiber节点"}},[t._v("#")]),t._v(" JSX与Fiber节点")]),t._v(" "),a("p",[t._v("从上面的内容我们可以发现，"),a("code",[t._v("JSX")]),t._v("是一种描述当前组件内容的数据结构，他不包含组件"),a("strong",[t._v("schedule")]),t._v("、"),a("strong",[t._v("reconcile")]),t._v("、"),a("strong",[t._v("render")]),t._v("所需的相关信息。")]),t._v(" "),a("p",[t._v("比如如下信息就不包括在"),a("code",[t._v("JSX")]),t._v("中：")]),t._v(" "),a("ul",[a("li",[t._v("组件在更新中的"),a("code",[t._v("优先级")])]),t._v(" "),a("li",[t._v("组件的"),a("code",[t._v("state")])]),t._v(" "),a("li",[t._v("组件被打上的用于"),a("strong",[t._v("Renderer")]),t._v("的"),a("code",[t._v("标记")])])]),t._v(" "),a("p",[t._v("这些内容都包含在"),a("code",[t._v("Fiber节点")]),t._v("中。")]),t._v(" "),a("p",[t._v("所以，在组件"),a("code",[t._v("mount")]),t._v("时，"),a("code",[t._v("Reconciler")]),t._v("根据"),a("code",[t._v("JSX")]),t._v("描述的组件内容生成组件对应的"),a("code",[t._v("Fiber节点")]),t._v("。")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("update")]),t._v("时，"),a("code",[t._v("Reconciler")]),t._v("将"),a("code",[t._v("JSX")]),t._v("与"),a("code",[t._v("Fiber节点")]),t._v("保存的数据对比，生成组件对应的"),a("code",[t._v("Fiber节点")]),t._v("，并根据对比结果为"),a("code",[t._v("Fiber节点")]),t._v("打上"),a("code",[t._v("标记")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"第三章-render阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第三章-render阶段"}},[t._v("#")]),t._v(" 第三章 render阶段")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[a("code",[t._v("Fiber节点")]),t._v("是如何被创建并构建"),a("code",[t._v("Fiber树")]),t._v("的？")])]),a("h3",{attrs:{id:"流程概览"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流程概览"}},[t._v("#")]),t._v(" 流程概览")]),t._v(" "),a("p",[t._v("​\t"),a("code",[t._v("render阶段")]),t._v("开始于"),a("code",[t._v("performSyncWorkOnRoot")]),t._v("或"),a("code",[t._v("performConcurrentWorkOnRoot")]),t._v("方法的调用。这取决于本次更新是同步更新还是异步更新。")]),t._v(" "),a("p",[t._v("而这两个方法会调用如下两个方法：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// performSyncWorkOnRoot会调用该方法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("workLoopSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("performUnitOfWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// performConcurrentWorkOnRoot会调用该方法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("workLoopConcurrent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("shouldYield")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("performUnitOfWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("workInProgress"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br")])]),a("p",[t._v("​\t可以看到，它们唯一的区别是是否调用"),a("code",[t._v("shouldYield")]),t._v("。如果当前浏览器帧没有剩余时间，"),a("code",[t._v("shouldYield")]),t._v("会中止循环，知道浏览器有空闲时间后再继续遍历。")]),t._v(" "),a("p",[t._v("​\t"),a("code",[t._v("workInProgress")]),t._v("代表当前已创建的"),a("code",[t._v("workInProgress fiber")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"第四章-commit阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第四章-commit阶段"}},[t._v("#")]),t._v(" 第四章 commit阶段")]),t._v(" "),a("h2",{attrs:{id:"第五章-diff算法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第五章-diff算法"}},[t._v("#")]),t._v(" 第五章 Diff算法")]),t._v(" "),a("h2",{attrs:{id:"第六章-状态更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第六章-状态更新"}},[t._v("#")]),t._v(" 第六章 状态更新")]),t._v(" "),a("h2",{attrs:{id:"第七章-hooks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第七章-hooks"}},[t._v("#")]),t._v(" 第七章 Hooks")]),t._v(" "),a("h2",{attrs:{id:"第八章-concurrent-mode"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第八章-concurrent-mode"}},[t._v("#")]),t._v(" 第八章 Concurrent Mode")]),t._v(" "),a("h2",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://react.iamkasong.com/preparation/file.html#%E9%A1%B6%E5%B1%82%E7%9B%AE%E5%BD%95",target:"_blank",rel:"noopener noreferrer"}},[t._v("React技术解密"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);