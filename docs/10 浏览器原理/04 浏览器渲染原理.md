---
title: 浏览器04:渲染原理
date: 2022-03-23
sidebar: 'auto'
categories:
- 10浏览器
isShowComments: true
---

## 1. 浏览器渲染过程

### 1. 构建DOM树

​	HTML文件的结构没法被浏览器理解，所以先要把HTML中的标签变成一个可以给JS使用的结构。

在控制台可以尝试打印document，这就是解析出来的DOM树。

![图片](https://gitee.com/ljcdzh/my_pic/raw/master/img/202203231632528.png)



### 2. 样式计算

CSS文件一样没法被浏览器直接理解，所以首先把CSS解析成样式表。这三类样式都会被解析：

- 通过 link 引用的外部 CSS 文件

- <style>标签内的样式

- 元素的 style 属性内嵌的 CSS

在控制台打印`document.styleSheets`，这就是解析出的样式表。

![图片](https://gitee.com/ljcdzh/my_pic/raw/master/img/202203231632757.png)

​	利用这份样式表，我们可以计算出DOM树中每个节点的样式。之所以叫计算，是因为每个元素要继承其父元素的属性。

```
<style>
    span {
        color: red
    }
    div {
        font-size: 30px
    }
</style>
<div>
    <span>年年</span>
</div>
```

比如上面的`年年`，不仅要接受span设定的样式，还要继承div设置的。

DOM树中的节点有了样式，现在被叫做渲染树。



### 3. 布局定位

上面详细的讲述了HTML和CSS加载、解析过程，现在我们的渲染树中的节点有了样式，但是不知道要画在哪个位置。所以还需要另外一颗布局树确定元素的几何定位。

布局树只取渲染树中的可见元素，意味着head标签，`display:none`的元素不会被添加。



### 4. 图层分层

​	现在我们有了布局树，但依旧不能直接开始绘制，在此之前需要分层，生成一棵对应的图层树。浏览器的页面实际上被分成了很多图层，这些图层叠加后合成了最终的页面。

​	因为页面中有很多复杂的效果，如一些复杂的 3D 变换、页面滚动，或者使用 z-index 做 z 轴排序等，我们希望能更加方便地实现这些效果。

​	并不是布局树的每个节点都能生成一个图层，如果一个节点没有自己的层，那么这个节点就从属于父节点的图层

​	通常满足下面两点中任意一点的元素就可以被提升为单独的一个图层。

​	1、拥有层叠上下文属性的元素会被提升为单独的一层：明确定位属性`position`的元素、定义透明属性`opacity`的元素、使用 CSS 滤镜`filter`的元素等，都拥有层叠上下文属性。

​	2、需要剪裁（clip）的地方也会被创建为图层`overflow`

在chrome的开发者工具：`更多选项-更多工具-Layers`可以看到图层的分层情况。

![图片](https://gitee.com/ljcdzh/my_pic/raw/master/img/202203162156758.png)



### 5. 图层绘制

在完成图层树的构建之后，接下来终于到对每个图层进行绘制。首先会把图层拆解成一个一个的绘制指令，排布成一个绘制列表，在上文提到的开发者工具的Layers面板中，点击detail中的profiler可以看到绘制列表。

至此，渲染进程中的主线程——GUI渲染线程已经完成了它所有任务，接下来交给渲染进程中的合成线程。

合成线程接下来会把视口拆分成图块，把图块转换成位图。





### 6. 显示

至此，渲染进程的工作全部完成，接下来会把生成的位图还给浏览器进程，最后在页面上显示。
