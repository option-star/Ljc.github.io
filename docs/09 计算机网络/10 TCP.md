---
title: 计网10 TCP
date: 2022-03-31
sidebar: 'auto'
categories:
- 09计网
isShowComments: true
---

## 1. TCP头格式

> TCP头部格式

![TCP 头格式](https://cdn.jsdelivr.net/gh/option-star/imgs/202204080741087.png)

- **序列号**： 在建立连接时由计算机生成的随机数作为其初始值。用来解决网络包乱序问题。

- **确认应答号**： 指下次期望收到的数据的序列号，发送端收到后可以认为这个序列号之前的数据被正常接收，用来解决丢包问题。

- **控制位**

  - `ACK`: 该位为1时，确认应答的字段变为有效
  - `RST`:该位为1时，表示TCP连接中出现异常必须强制断开连接
  - `SYN`:该位为1时，表示希望建立连接 
  - `FIN`: 该位为1时，表示希望断开连接

  

## 2. 为什么需要TCP协议？

**结论**： 保障网络数据包的可靠性

​	`IP` 层是「不可靠」的，它不保证网络包的交付、不保证网络包的按序交付、也不保证网络包中的数据的完整性。

​	如果需要保障网络数据包的可靠性，那么就需要由上层（传输层）的 `TCP` 协议来负责。



## 3. 什么是TCP？

TCP是面向连接的、可靠的、基于字节流的传输层通信协议。

- **面向连接**：表示一对一连接
- **可靠的**：保证一个报文一定能够到达接收端
- **字节流**：消息没有边界，并且消息是有序的。



## 4. 什么是TCP连接？

> 连接的定义

**连接**： 用于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括socket、序列号和窗口大小称为连接

> 建立一个TCP的三个条件

- Socket: 由IP地址和端口号组成
- 序列号：用来解决乱序问题等
- 窗口大小：用来做流量控制



## 5. 如何确定一个TCP连接呢？

![TCP 四元组](https://cdn.jsdelivr.net/gh/option-star/imgs/202204080821293.png)

- 源地址和目的地址的字段（32位）是在 IP 头部中，作用是通过 IP 协议发送报文给对方主机。

- 源端口和目的端口的字段（16位）是在 TCP 头部中，作用是告诉 TCP 协议应该把报文发给哪个进程。

## 6. 有一个IP的服务器监听了一个端口，它的TCP的最大连接数是多少？

![img](https://cdn.jsdelivr.net/gh/option-star/imgs/202204080823602.png)

> IPv4

IP数： `2^32`

端口数： `2^16`

最大TCP连接数： `2^48`

> 受限

- **文件描述符**： 每个TCP连接都是一个文件，如果文件描述符被占满了 ，会发生`too many open files`
- **内存限制**： 每个TCP连接都占用一定的内存，而操作系统的内存有限，如果内存资源被占满会发生OOM（内存泄漏）。



## 7. UDP头部格式

![UDP 头部格式](https://cdn.jsdelivr.net/gh/option-star/imgs/202204080831792.png)

- **目标和源端口**： 主要告诉UDP协议应该把报文发给哪个进程
- **包长度**： 该字段保存了UDP首部的长度和数据的长度之和
- **校验和**： 防止收到的网络传输中受损的UDP包



## 8. UDP与TCP的区别

|                    |                          TCP                          |                           UDP                           |
| :----------------: | :---------------------------------------------------: | :-----------------------------------------------------: |
|        连接        |                 传输数据前先建立连接                  |                不需要连接，即刻传输数据                 |
|      服务对象      |                   一对一，两个端点                    |                 一对一、一对多、多对多                  |
|       可靠性       |                     可靠交付数据                      |               尽最大努力交付，不保证可靠                |
| 拥塞控制、流量控制 |               具有，保证数据传输的安全                |                          没有                           |
|      首部开销      |            没有使用选项时，20字节，开销大             |               8字节，长度固定不变，开销小               |
|      传输方式      |         流式传输，没有边界，但保证顺序和可靠          |       一个一个包发送，有边界，但可能会丢包和乱序        |
|      分片不同      | 大于MSS大小，会进行分片，中途丢失，只需传输丢失的分片 |                   大于MTU，会进行分片                   |
|      应用场景      |                 `FTP`文件传输、HTTPS                  | 包总量较少的通信`DNS`、视频、音频等多媒体通信、广播通信 |

## 9. 为什么TCP具有首部字段，而UDP没有

因为TCP有可变长字段——选项，而UDP首部长度不变，无需多一个字段记录UDP首部长度



## 10. 为什么UDP头部有包长度字段，而TCP没有呢？

![img](https://cdn.jsdelivr.net/gh/option-star/imgs/202204080901738.png)

**因为为了网络设备硬件设计和处理方便，首部长度需要`4`字节的整数倍**



## 11. TCP三次握手过程和状态变迁

![TCP 三次握手](https://cdn.jsdelivr.net/gh/option-star/imgs/202204080904421.png)

1. 一开始，客户端和服务端处于`ClOSED`状态。先是服务端主动监听某个端口，处于`LISTEN`状态
2. 客户端会随机初始化序列号`client_isn`，将该序号置于TCP首部的[序号]字段中，同时把`SYN`标志位置为1，表示`SYN`报文。然后把SYN包发送给服务端，之后客户端处于`SYN—SENT`状态
3. 服务端收到客户端的`SYN`报文后，首先服务端也随机初始化自己的序号`server_isn`， 将此序号填入TCP首部的[序号]字段中，其次把TCP首部的[确认应答号]字段填入`client_isn + 1`, 接着把`SYN`和`ACK`标志位置为`1`。最后把报文发给客户端，之后服务端处于`SYN_REVD`状态
4. 客户端收到服务端报文后，还要向服务端回应最后一个应答报文，ACK置为1，确认应答号填入`server_isn + 1`，发送报文给服务端，这次报文可以携带客户到服务器的数据，之后客户端处于`ESTABLISHED`状态。
5. 服务器收到客户端的应答报文后，也进入`ESTABLED`状态。



## 12. 为什么是三次握手？不是两次？四次？

TCP 建立连接时，通过三次握手**能防止历史连接的建立，能减少双方不必要的资源开销，能帮助双方同步初始化序列号**。序列号能够保证数据包不重复、不丢弃和按序传输。

- **两次握手**： 无法防止历史连接的建立，会造成双方资源的浪费，也无法可靠的同步双方序列号。
- **四次握手**：三次握手就可以理论上最少可靠连接建立，所以不需要使用更多的通讯次数。

> 防止历史连接的建立

场景：客户端连续发送多个SYN建立连接的报文，在网络拥堵的情况下：

- 一个「旧 SYN 报文」比「最新的 SYN 」 报文早到达了服务端；
- 那么此时服务端就会回一个 `SYN + ACK` 报文给客户端；
- 客户端收到后可以根据自身的上下文，判断这是一个历史连接（序列号过期或超时），那么客户端就会发送 `RST` 报文给服务端，表示中止这一次连接。

​	**在两次握手的情况下，[被动发起方]没有中间状态给[主动发起方]来阻止历史连接，导致[被动发起方]可能建立一个历史连接，造成资源浪费。**

> 同步双方初始序列号

TCP 协议的通信双方， 都必须维护一个「序列号」， 序列号是可靠传输的一个关键因素，它的作用：

- 接收方可以去除重复的数据；
- 接收方可以根据数据包的序列号按序接收；
- 可以标识发送出去的数据包中， 哪些是已经被对方收到的（通过 ACK 报文中的序列号知道）；

两次握手只保证了一方的初始化序列号能被对方成功接收，没法保证双方的初始序列号都能被确认接收。



## 3）避免资源浪费



